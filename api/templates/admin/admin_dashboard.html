{% extends "admin/base.html" %}

{% load i18n static jazzmin admin_urls %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
{% get_jazzmin_settings request as jazzmin_settings %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block sidebar %}
    {% if jazzmin_settings.show_sidebar %}
        {% get_side_menu as side_menu_list %}

        <aside class="main-sidebar elevation-4 {{ jazzmin_ui.sidebar_classes }}" id="jazzy-sidebar">
            <a class="brand-link {{ jazzmin_ui.brand_classes }}" id="jazzy-logo">
                <img src="{% static jazzmin_settings.site_logo %}" alt="{{ jazzmin_settings.site_header }} Logo" class="{{ jazzmin_settings.site_logo_classes }} brand-image elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">{{ jazzmin_settings.site_brand }}</span>
            </a>

            <div class="sidebar">
                <nav class="mt-2 sidebar-scroll">
                    <ul class="nav nav-pills nav-sidebar flex-column {{ jazzmin_ui.sidebar_list_classes }}" data-widget="treeview" role="menu" data-collapsible="false">

                        <li class="nav-item">
                            <a href="{% url 'dashboard_page' %}" class="nav-link">
                                <i class="nav-icon fas fa-th-large"></i>
                                <p>{% trans 'Dashboard' %}</p>
                            </a>
                        </li>

                        {% if jazzmin_settings.navigation_expanded %}
                            {% for app in side_menu_list %}
                                <li class="nav-header">{{ app.name }}</li>
                                {% for model in app.models %}
                                    <li class="nav-item">
                                        {% if model.url %}
                                        <a href="{{ model.url }}" class="nav-link">
                                            <i class="nav-icon {{ model.icon }}"></i> <p>{{ model.name }}</p>
                                        </a>
                                    {% else %}
                                        <span class="nav-link disabled">
                                            <i class="nav-icon {{ model.icon }}"></i> <p>{{ model.name }}</p>
                                        </span>
                                    {% endif %}
                                    </li>
                                {% endfor %}
                            {% endfor %}
                        {% else %}
                            {% for app in side_menu_list %}
                                <li class="nav-item has-treeview">
                                    <a href="#" class="nav-link">
                                        <i class="nav-icon {{ app.icon }}"></i>
                                        <p>{{ app.name|truncatechars:21 }} <i class="fas fa-angle-left right"></i></p>
                                    </a>
                                    <ul class="nav nav-treeview" style="display: none;">
                                        {% for model in app.models %}
                                            <li class="nav-item">
                                                <a href="{% if model.url %}{{ model.url }}{% else %}javascript:void(0){% endif %}" class="nav-link">
                                                    <i class="nav-icon {{ model.icon }}"></i>
                                                    <p>{{ model.name }}</p>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </aside>
    {% endif %}
{% endblock %}

{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

    .container {
        max-width: 1500px;
    }

    .custom-row-spacing {
        margin-bottom: 20px;
    }
   
    .card-margin {
        margin-bottom: 1.875rem;
    }

    .card {
        border: 0;
        box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -webkit-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -moz-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -ms-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
    }

    .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: rgba(60, 179, 209, 0.3);
        background-clip: border-box;
        border: 1px solid #e6e4e9;
        border-radius: 15px;
        font-family: "Arial";
    }

    .graph-container {
        background-color: rgba(60, 179, 209, 0.3);
        border-radius: 15px;
        padding: 10px 10px 10px 10px;
    }

    .card-body {
        font-family: "Arial";
    }

    .card .card-header.no-border {
        border: 0;
    }

    .card .card-header {
        background: none;
        padding: 0 0.9375rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        min-height: 50px;
    }

    .card-header:first-child {
        border-radius: calc(8px - 1px) calc(8px - 1px) 0 0;
    }

    .dashboard-cards .dashboard-title-wrapper {
        display: flex;
        align-items: center;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-date-primary {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-color: #edf1fc;
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-title-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-color: #e8faf8;
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        margin-right: 10px;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-header {
        display: flex;
        flex-direction: column;
        margin-left: 1rem;
    }

    .dashboard-cards .dashboard-fields {
        font-weight: 400;
        font-size: 13px;
        margin-top: .5rem;
    }

    .dashboard-cards .dashboard-fields .dashboard-sub-fileds {
        display: list-item;
        color: #727686;
        margin-bottom: 10px;
    }

    .dashboard-title {
        text-align: left;
    }

    .chart-heading {
        font-size: 40px;
        font-weight: bold;
        margin-bottom: 30px;
    }

    .chart-heading-small {
        font-size: 30px;
        padding: 5px 15px;
    }

    .reset-filter, .reset-year-filter {
        cursor: pointer;
        color: red;
    }

    .dashboard-title-wrapper {
        border-bottom: 1px solid #464545;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .dashboard-pro-title, .dashboard-total-counts {
        font-size: 20px;
        font-weight: 900;
    }

    .yearFilter, .bookingStatusFilter, .agentYearFilter, .agentStageFilter {
        appearance: none;
        padding: 3px 3px 3px 3px;
        border: 1px solid #caced1;
        border-radius: 0.25rem;
        color: #000;
        cursor: pointer;
        margin-left: 5px;
    }

    .dashboard-field, .dashboard-field-value {
        font-size: 16px;
        font-weight: 900;
    }
    
    </style>
</head>

<div class="container">
    <h1 class="mt-4 mb-4 dashboard-title">Dashboard</h1>

    <div class="row">
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M300-80q-58 0-99-41t-41-99v-520q0-58 41-99t99-41h500v600q-25 0-42.5 17.5T740-220q0 25 17.5 42.5T800-160v80H300Zm-60-267q14-7 29-10t31-3h20v-440h-20q-25 0-42.5 17.5T240-740v393Zm160-13h320v-440H400v440Zm-160 13v-453 453Zm60 187h373q-6-14-9.5-28.5T660-220q0-16 3-31t10-29H300q-26 0-43 17.5T240-220q0 26 17 43t43 17Z"/></svg>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Total Bookings</span>
                                <span class="dashboard-total-counts">{{ cards.total_bookings_count }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Successful: </span><span class="dashboard-field-value">{{ cards.successful_bookings }}</span></li>
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Cancelled: </span><span class="dashboard-field-value">{{ cards.refunded_bookings }}</span></li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Failed: </span><span class="dashboard-field-value">{{ cards.failed_bookings }}</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm720 0v-120q0-44-24.5-84.5T666-434q51 6 96 20.5t84 35.5q36 20 55 44.5t19 53.5v120H760ZM360-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm400-160q0 66-47 113t-113 47q-11 0-28-2.5t-28-5.5q27-32 41.5-71t14.5-81q0-42-14.5-81T544-792q14-5 28-6.5t28-1.5q66 0 113 47t47 113ZM120-240h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0 320Zm0-400Z"/></svg>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Total Agents</span>
                                <span class="dashboard-total-counts">{{ cards.total_agent_count }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Active: </span><span class="dashboard-field-value">{{ cards.active_agents }}</span></li>
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Inactive: </span><span class="dashboard-field-value">{{ cards.inactive_agents }}</span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Rejected: </span><span class="dashboard-field-value">{{ cards.rejected_agents }}</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M560-440q-50 0-85-35t-35-85q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35ZM280-320q-33 0-56.5-23.5T200-400v-320q0-33 23.5-56.5T280-800h560q33 0 56.5 23.5T920-720v320q0 33-23.5 56.5T840-320H280Zm80-80h400q0-33 23.5-56.5T840-480v-160q-33 0-56.5-23.5T760-720H360q0 33-23.5 56.5T280-640v160q33 0 56.5 23.5T360-400Zm440 240H120q-33 0-56.5-23.5T40-240v-440h80v440h680v80ZM280-400v-320 320Z"/></svg>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Agent Transaction</span>
                                <span class="dashboard-total-counts">{{ cards.total_agent_transaction_count }}</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Successful: </span><span class="dashboard-field-value">{{ cards.successful_agent_transaction_count }}</span></li>
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Pending: </span><span class="dashboard-field-value">{{ cards.pending_agent_transaction_count }}</span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Failed: </span><span class="dashboard-field-value">{{ cards.failed_agent_transaction_count }}</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M560-440q-50 0-85-35t-35-85q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35ZM280-320q-33 0-56.5-23.5T200-400v-320q0-33 23.5-56.5T280-800h560q33 0 56.5 23.5T920-720v320q0 33-23.5 56.5T840-320H280Zm80-80h400q0-33 23.5-56.5T840-480v-160q-33 0-56.5-23.5T760-720H360q0 33-23.5 56.5T280-640v160q33 0 56.5 23.5T360-400Zm440 240H120q-33 0-56.5-23.5T40-240v-440h80v440h680v80ZM280-400v-320 320Z"/></svg>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">User Transaction</span>
                                <span class="dashboard-total-counts">{{ cards.total_user_transaction_count }}</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Refunded: </span><span class="dashboard-field-value">{{ cards.refunded_user_transaction_count }}</span></li>
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Pending: </span><span class="dashboard-field-value">{{ cards.pending_user_transaction_count }}</span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span class="dashboard-field">Cancelled: </span><span class="dashboard-field-value">{{ cards.cancelled_user_transaction_count }}</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <div class="graph-container">
                <div class="chart-container">
                    <div class="chart-heading chart-heading-small">Booking Graph</div>
                    <div class="chart-wrapper">
                        <canvas id="bookingChart"></canvas>
                    </div>
                </div>

                <div class="row pt-3">
                    <div class="col-lg-4">
                        <label for="yearFilter">Filter by Year:</label>
                        <select id="yearFilter"  class="yearFilter" onchange="applyYearFilter()">
                            {% for year in years_list %}
                                <option value="{{ year }}" {% if year == request.GET.year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <span id="resetYearFilter" class="reset-year-filter" style="display: {% if request.GET.year %}inline{% else %}none{% endif %}">Reset</span>
                    </div>
                    <div class="col-lg-8">
                        <label for="bookingStatusFilter">Filter by Booking Status:</label>
                        <select id="bookingStatusFilter" class="bookingStatusFilter" onchange="applyFilter()">
                            <option value="">Show All</option>
                            <option value="SUCCESSFUL" {% if request.GET.booking_status == "SUCCESSFUL" %}selected{% endif %}>SUCCESSFUL</option>
                            <option value="REFUNDED" {% if request.GET.booking_status == "REFUNDED" %}selected{% endif %}>REFUNDED</option>
                            <option value="FAILED" {% if request.GET.booking_status == "FAILED" %}selected{% endif %}>FAILED</option>
                        </select>
                        <span id="resetFilter" class="reset-filter" style="display: {% if request.GET.booking_status %}inline{% else %}none{% endif %}">Reset</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="graph-container">
                <div class="chart-container">
                    <div class="chart-heading chart-heading-small">Agent Graph</div>
                    <div class="chart-wrapper">
                        <canvas id="agentChart"></canvas>
                    </div>
                </div>

                <div class="row pt-3">
                    <div class="col-lg-4">
                        <label for="agentYearFilter">Filter by Year:</label>
                        <select id="agentYearFilter"  class="agentYearFilter" onchange="applyAgentYearFilter()">
                            {% for year in years_list %}
                                <option value="{{ year }}" {% if year == request.GET.bar_graph_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <span id="resetAgentYearFilter" class="reset-year-filter" style="display: {% if request.GET.bar_graph_year %}inline{% else %}none{% endif %}">Reset</span>
                    </div>
                    <div class="col-lg-8">
                        <label for="agentStageFilter">Filter by Agent Stage:</label>
                        <select id="agentStageFilter" class="agentStageFilter" onchange="applyAgentFilter()">
                            <option value="">Show All</option>
                            <option value="approved" {% if request.GET.agent_stage_status == "approved" %}selected{% endif %}>APPROVED</option>
                            <option value="pending" {% if request.GET.agent_stage_status == "pending" %}selected{% endif %}>PENDING</option>
                            <option value="rejected" {% if request.GET.agent_stage_status == "rejected" %}selected{% endif %}>REJECTED</option>
                        </select>
                        <span id="resetAgentFilter" class="reset-filter" style="display: {% if request.GET.agent_stage_status %}inline{% else %}none{% endif %}">Reset</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var ctx = document.getElementById('bookingChart').getContext('2d');
    var bookingChart;

    function applyFilter() {
        var filterOption = document.getElementById('bookingStatusFilter').value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('booking_status', filterOption);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('booking_status');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });

    bookingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [ {% for item in barchart_booking %}'{{ item.month }}',{% endfor %} ],
            datasets: [{
                label: 'Count',
                data: [ {% for item in barchart_booking %}{{ item.count }},{% endfor %} ],
                backgroundColor: 'rgb(30, 144, 255)',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    stepSize: 50,
                    ticks: {
                        stepSize: 5,
                        min: 0,
                        max: 10000
                    }
                },
                x: {
                    grid: {
                        display: false // Hides vertical grid lines
                    }
                }
            }
        }
    });

    function applyYearFilter() {
        var selectedYear = document.getElementById('yearFilter').value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('year', selectedYear);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetYearFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('year');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });
</script>

<script>
    var ctx = document.getElementById('agentChart').getContext('2d');
    var agentChart;

    function applyAgentFilter() {
        var filterOption = document.getElementById('agentStageFilter').value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('agent_stage_status', filterOption);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetAgentFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('agent_stage_status');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });

    agentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [ {% for item in agent_chart_booking %}'{{ item.month }}',{% endfor %} ],
            datasets: [{
                label: 'Count',
                data: [ {% for item in agent_chart_booking %}{{ item.count }},{% endfor %} ],
                backgroundColor: 'rgb(88, 199, 62)',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    stepSize: 50,
                    ticks: {
                        stepSize: 5,
                        min: 0,
                        max: 10000
                    }
                },
                x: {
                    grid: {
                        display: false // Hides vertical grid lines
                    }
                }
            }
        }
    });

    function applyAgentYearFilter() {
        var filterOption = document.getElementById('agentYearFilter').value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('bar_graph_year', filterOption);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetAgentYearFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('bar_graph_year');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });
</script>
{% endblock %}