{% extends "admin/base.html" %}

{% load i18n static jazzmin admin_urls %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
{% get_jazzmin_settings request as jazzmin_settings %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block sidebar %}
    {% if jazzmin_settings.show_sidebar %}
        {% get_side_menu as side_menu_list %}

        <aside class="main-sidebar elevation-4 {{ jazzmin_ui.sidebar_classes }}" id="jazzy-sidebar">
            <a href="{% url 'admin:index' %}" class="brand-link {{ jazzmin_ui.brand_classes }}" id="jazzy-logo">
                <img src="{% static jazzmin_settings.site_logo %}" alt="{{ jazzmin_settings.site_header }} Logo" class="{{ jazzmin_settings.site_logo_classes }} brand-image elevation-3" style="opacity: .8">
                <span class="brand-text font-weight-light">{{ jazzmin_settings.site_brand }}</span>
            </a>

            <div class="sidebar">
                <nav class="mt-2 sidebar-scroll">
                    <ul class="nav nav-pills nav-sidebar flex-column {{ jazzmin_ui.sidebar_list_classes }}" data-widget="treeview" role="menu" data-collapsible="false">

                        <li class="nav-item">
                            <a href="{% url 'dashboard_page' %}" class="nav-link">
                                <i class="nav-icon fas fa-th-large"></i>
                                <p>{% trans 'Dashboard' %}</p>
                            </a>
                        </li>

                        {% if jazzmin_settings.navigation_expanded %}
                            {% for app in side_menu_list %}
                                <li class="nav-header">{{ app.name }}</li>
                                {% for model in app.models %}
                                    <li class="nav-item">
                                        {% if model.url %}
                                        <a href="{{ model.url }}" class="nav-link">
                                            <i class="nav-icon {{ model.icon }}"></i> <p>{{ model.name }}</p>
                                        </a>
                                    {% else %}
                                        <span class="nav-link disabled">
                                            <i class="nav-icon {{ model.icon }}"></i> <p>{{ model.name }}</p>
                                        </span>
                                    {% endif %}
                                    </li>
                                {% endfor %}
                            {% endfor %}
                        {% else %}
                            {% for app in side_menu_list %}
                                <li class="nav-item has-treeview">
                                    <a href="#" class="nav-link">
                                        <i class="nav-icon {{ app.icon }}"></i>
                                        <p>{{ app.name|truncatechars:21 }} <i class="fas fa-angle-left right"></i></p>
                                    </a>
                                    <ul class="nav nav-treeview" style="display: none;">
                                        {% for model in app.models %}
                                            <li class="nav-item">
                                                <a href="{% if model.url %}{{ model.url }}{% else %}javascript:void(0){% endif %}" class="nav-link">
                                                    <i class="nav-icon {{ model.icon }}"></i>
                                                    <p>{{ model.name }}</p>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </aside>
    {% endif %}
{% endblock %}

{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

    .container {
        max-width: 1500px;
    }

    .custom-row-spacing {
        margin-bottom: 20px;
    }
   
    .card-margin {
        margin-bottom: 1.875rem;
    }

    .card {
        border: 0;
        box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -webkit-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -moz-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
        -ms-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
    }

    .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: rgba(60, 179, 209, 0.3);
        background-clip: border-box;
        border: 1px solid #e6e4e9;
        border-radius: 15px;
        font-family: "Arial";
    }

    .card-body {
        font-family: "Arial";
    }

    .card .card-header.no-border {
        border: 0;
    }

    .card .card-header {
        background: none;
        padding: 0 0.9375rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        min-height: 50px;
    }

    .card-header:first-child {
        border-radius: calc(8px - 1px) calc(8px - 1px) 0 0;
    }

    .dashboard-cards .dashboard-title-wrapper {
        display: flex;
        align-items: center;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-date-primary {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-color: #edf1fc;
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-title-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-color: #e8faf8;
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        margin-right: 10px;
    }

    .dashboard-cards .dashboard-title-wrapper .dashboard-header {
        display: flex;
        flex-direction: column;
        margin-left: 1rem;
    }

    .dashboard-cards .dashboard-fields {
        font-weight: 400;
        font-size: 13px;
        margin-top: .5rem;
    }

    .dashboard-cards .dashboard-fields .dashboard-sub-fileds {
        display: list-item;
        color: #727686;
        margin-bottom: 10px;
    }

    .dashboard-title {
        text-align: center;
    }

    .chart-heading {
        font-size: 40px;
        font-weight: bold;
        margin-bottom: 30px;
    }

    .chart-heading-small {
        font-size: 30px;
        padding: 5px 15px;
    }

    .reset-filter, .reset-year-filter {
        text-decoration: underline;
        cursor: pointer;
        color: red;
    }

    .dashboard-title-wrapper {
        border-bottom: 1px solid #464545;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .dashboard-pro-title, .dashboard-total-counts {
        font-size: 20px;
    }

    .yearFilter, .bookingStatusFilter {
        appearance: none;
        padding: 0.675em 1em 0.675em 1em;
        border: 1px solid #caced1;
        border-radius: 0.25rem;
        color: #000;
        cursor: pointer;
    }
    
    </style>
</head>

<div class="container">
    <h1 class="mt-4 mb-4 dashboard-title">Admin Dashboard</h1>

    <div class="row">
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <span class="fa fa-book"></span>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Total Bookings</span>
                                <span class="dashboard-total-counts">{{ cards.total_bookings_count }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Successful:</span> <span><b>{{ cards.successful_bookings }}</b></span></li>
                                    <li class="dashboard-sub-fileds"><span>Cancelled:</span> <span><b>{{ cards.refunded_bookings }}</b></span></li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Failed:</span> <span><b></b>{{ cards.failed_bookings }}</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <span class="fa fa-book"></span>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Total Agents</span>
                                <span class="dashboard-total-counts">{{ cards.total_agent_count }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Active:</span> <span><b>{{ cards.active_agents }}</b></span></li>
                                    <li class="dashboard-sub-fileds"><span>Inactive:</span> <span><b>{{ cards.inactive_agents }}</b></span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Rejected:</span> <span><b>{{ cards.rejected_agents }}</b></span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <span class="fa fa-book"></span>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">Agent Transaction</span>
                                <span class="dashboard-total-counts">{{ cards.total_agent_transaction_count }}</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span> Successful:</span> <span><b>{{ cards.successful_agent_transaction_count }}</b></span></li>
                                    <li class="dashboard-sub-fileds"><span>Pending:</span> <span><b>{{ cards.pending_agent_transaction_count }}</b></span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Failed:</span> <span><b>{{ cards.failed_agent_transaction_count }}</b></span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-margin">
                <div class="card-body pt-3">
                    <div class="dashboard-cards">
                        <div class="dashboard-title-wrapper">
                            <div class="dashboard-title-icon">
                                <span class="fa fa-book"></span>
                            </div>
                            <div class="dashboard-header">
                                <span class="dashboard-pro-title">User Transaction</span>
                                <span class="dashboard-total-counts">{{ cards.total_user_transaction_count }}</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span> Refunded:</span> <span><b>{{ cards.refunded_user_transaction_count }}</b></span></li>
                                    <li class="dashboard-sub-fileds"><span>Pending:</span> <span><b>{{ cards.pending_user_transaction_count }}</b></span></li>
                                </ol>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol class="dashboard-fields list-unstyled">
                                    <li class="dashboard-sub-fileds"><span>Cancelled:</span> <span><b>{{ cards.cancelled_user_transaction_count }}</b></span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <div>
                <div class="chart-container">
                    <div class="chart-heading chart-heading-small">Booking Graph</div>
                    <div class="chart-wrapper">
                        <canvas id="bookingChart"></canvas>
                    </div>
                </div>

                <div class="row pt-3">
                    <div class="col-lg-4">
                        <label for="yearFilter">Filter by Year:</label>
                        <select id="yearFilter"  class="yearFilter" onchange="applyYearFilter()">
                            {% for year in years_list %}
                                <option value="{{ year }}" {% if year == request.GET.year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <span id="resetYearFilter" class="reset-year-filter" style="display: {% if request.GET.year %}inline{% else %}none{% endif %}">Reset Year Filter</span>
                    </div>
                    <div class="col-lg-6">
                        <label for="bookingStatusFilter">Filter by Booking Status:</label>
                        <select id="bookingStatusFilter" class="bookingStatusFilter" onchange="applyFilter()">
                            <option value="">Show All</option>
                            <option value="SUCCESSFUL" {% if request.GET.booking_status == "SUCCESSFUL" %}selected{% endif %}>SUCCESSFUL</option>
                            <option value="REFUNDED" {% if request.GET.booking_status == "REFUNDED" %}selected{% endif %}>REFUNDED</option>
                            <option value="FAILED" {% if request.GET.booking_status == "FAILED" %}selected{% endif %}>FAILED</option>
                        </select>
                        <span id="resetFilter" class="reset-filter" style="display: {% if request.GET.booking_status %}inline{% else %}none{% endif %}">Reset Booking Filter</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div>
                <div class="chart-heading chart-heading-small">Agent Bar Graph</div>
                <canvas id="agent-chart" data-url="{% url 'agent-chart' %}"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    var ctx = document.getElementById('bookingChart').getContext('2d');
    var bookingChart;

    function applyFilter() {
        var filterOption = document.getElementById('bookingStatusFilter').value;
        var currentUrl = new URL(window.location.href);
        console.log("currentUrl: 1 ",currentUrl);
        currentUrl.searchParams.set('booking_status', filterOption);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('booking_status');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });

    // Function to generate a random color
    function getRandomColor() {
        var r = Math.floor(Math.random() * 256); // Random value for red (0-255)
        var g = Math.floor(Math.random() * 256); // Random value for green (0-255)
        var b = Math.floor(Math.random() * 256); // Random value for blue (0-255)
        
        return 'rgb(' + r + ', ' + g + ', ' + b + ')';
    }

    var barchart_booking = {{ barchart_booking|safe }};

    // Generate random colors for each data point
    var randomColors = barchart_booking.map(() => getRandomColor());

    bookingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [ {% for item in barchart_booking %}'{{ item.month }}',{% endfor %} ],
            datasets: [{
                label: 'Booking Count',
                data: [ {% for item in barchart_booking %}{{ item.count }},{% endfor %} ],
                backgroundColor: randomColors,
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    stepSize: 50, // Base step size
                    ticks: {
                        stepSize: 5, // Set the base step size to 5
                        min: 0, // Set minimum value to 0
                        max: 10000 // Set maximum value to 200
                    }
                }
            }
        }
    });
</script>


<!-- Agent BarChart scripts with cdn -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
  <script>

    $(function () {

      var $agentChart = $("#agent-chart");
      $.ajax({
        url: $agentChart.data("url"),
        success: function (agent_data) {
            console.log(agent_data.labels);
          var ctx = $agentChart[0].getContext("2d");

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: agent_data.labels,
              datasets: [{
                label: 'Agent',
                backgroundColor: 'rgb(30, 144, 255)',
                data: agent_data.data
              }]          
            },
            options: {
              responsive: true,
              legend: {
                position: 'top',
              },
              title: {
                display: true,
                // text: 'Agent Bar Chart'
              },
              scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true // Ensure the y-axis starts from 0
                    }
                }]
            }
            }
          });

        }
      });

    });

  </script>

<script>
    function applyYearFilter() {
        var selectedYear = document.getElementById('yearFilter').value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('year', selectedYear);
        window.location.href = currentUrl;
    }

    // Function to remove filtering parameters and reload the page
    document.getElementById('resetYearFilter').addEventListener('click', function () {
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('year');
        // Reload the page with the updated URL
        window.location.href = currentUrl;
    });
</script>

{% endblock %}